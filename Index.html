<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selah | Jornada de Reflexão</title>
    
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">    
    <meta name="theme-color" content="#ffffff">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script type="module">
        // 1. IMPORTAÇÃO DO FIREBASE (Versão Web Modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // Migração para Firestore conforme o plano
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      
        const firebaseConfig = {
            apiKey: "AIzaSyCCtvfcH-gwjijmEopkQPJd9j9wryqC7sM",
            authDomain: "selah-4239f.firebaseapp.com",
            projectId: "selah-4239f",
            storageBucket: "selah-4239f.firebasestorage.app",
            messagingSenderId: "701076978159",
            appId: "1:701076978159:web:994dc9e7d56b4d95d0de1a",
            measurementId: "G-JFE9HLB1TM"
        };
      
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app); // Inicializado como Firestore

            // Exposição Global para compatibilidade com core.js/engine.js
            window.fireAuth = auth;
            window.fireDb = db;
            window.fireMethods = { 
                signInWithEmailAndPassword, 
                createUserWithEmailAndPassword, 
                signOut, 
                onAuthStateChanged,
                // Mapeamento de métodos Firestore para manter a estrutura esperada
                collection, 
                addDoc, 
                onSnapshot, 
                query, 
                where, 
                orderBy,
                getDocs,
                doc,
                deleteDoc,
                updateDoc
            };

            // 2. LÓGICA DE SINCRONIZAÇÃO (O "Ouvido Atento")
            let unsubscribeReflexoes = null;

            function ativarSincronizacao(user) {
                const reflexoesRef = collection(db, "reflexoes");
                
                const q = query(
                    reflexoesRef, 
                    where("uid", "==", user.uid),
                    orderBy("dataCriacao", "desc")
                );

                unsubscribeReflexoes = onSnapshot(q, (querySnapshot) => {
                    const listaReflexoes = [];
                    querySnapshot.forEach((doc) => {
                        listaReflexoes.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log("Selah: Dados sincronizados do Firestore", listaReflexoes);
                    
                    // Dispara evento para que seus outros scripts (view.js/controller.js) 
                    // possam reagir aos novos dados se necessário
                    window.dispatchEvent(new CustomEvent('data-updated', { detail: listaReflexoes }));
                });
            }

            // 3. MONITOR DE AUTENTICAÇÃO
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    ativarSincronizacao(user);
                } else {
                    if (unsubscribeReflexoes) unsubscribeReflexoes();
                }
            });

            // 4. FUNÇÕES GLOBAIS (Expostas para botões HTML)
            window.salvarReflexao = async function(texto, metadados = {}) {
                const user = auth.currentUser;
                if (!user) return alert("Por favor, faça login para salvar sua reflexão.");

                try {
                    await addDoc(collection(db, "reflexoes"), {
                        uid: user.uid,
                        conteudo: texto,
                        tema: metadados.tema || "",
                        dataReflexao: metadados.data || new Date().toISOString(),
                        link: metadados.link || "",
                        dataCriacao: new Date().toISOString()
                    });
                    console.log("Selah: Reflexão salva na nuvem!");
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    alert("Erro ao sincronizar com a nuvem.");
                }
            };

            window.dispatchEvent(new CustomEvent('firebase-ready'));
        } catch (e) {
            console.error("Erro crítico na inicialização do Firebase", e);
        }
    </script>
</head>
<body class="bg-stone-50 text-stone-800 font-sans h-screen flex flex-col overflow-hidden selection:bg-amber-100 selection:text-amber-900">

    <header class="bg-white border-b border-stone-200 px-4 md:px-6 py-3 flex items-center justify-between shadow-sm z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="hidden lg:flex items-center justify-center">
                <img src="img/logo.png" alt="Selah Logo" class="h-10 w-auto object-contain">
            </div>
            
            <div>
                <h1 class="text-xl font-serif font-bold tracking-tight text-stone-800">Selah</h1>
                <button onclick="ui.toggleChangelog(true)" class="text-[10px] font-bold tracking-wide text-amber-600 bg-amber-50 px-2 py-0.5 rounded border border-amber-100 hover:bg-amber-100 transition-colors cursor-pointer">
                    v1.0.0
                </button>
            </div>
        </div>

        <div class="flex gap-2 items-center relative">
            <button onclick="ui.openHeatmapModal()" class="flex group items-center gap-2 p-2 md:px-3 md:py-2 text-sm font-medium text-stone-600 bg-white border border-stone-300 rounded-lg hover:bg-stone-50 hover:text-amber-700 transition-all outline-none" title="Ver Constância">
                <i data-lucide="activity" class="w-4 h-4 text-stone-400 group-hover:text-amber-600"></i>
                <span class="hidden lg:inline">Radar Espiritual</span>
            </button>
            
            <button id="btn-new-study" onclick="ui.toggleModal('modal-new', true)" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-stone-800 rounded-lg hover:bg-stone-700 shadow-md transition-all active:scale-95 outline-none">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="hidden lg:inline">Nova Reflexão</span>
            </button>

            <div class="relative ml-1">
                <button id="user-menu-btn" class="w-10 h-10 rounded-full bg-stone-100 border border-stone-300 text-stone-400 flex items-center justify-center hover:bg-stone-200 transition-all">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </button>
                <div id="user-status-dot" class="absolute bottom-0 right-0 w-3 h-3 bg-stone-400 border-2 border-white rounded-full hidden"></div>
                
                <div id="auth-popover" class="hidden absolute top-full right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl border border-stone-100 z-[100]">
                    <div id="auth-view-login" class="p-5">
                        <form id="auth-form-popover" class="space-y-3">
                            <input type="email" id="popover-email" placeholder="Email" class="w-full text-xs border border-stone-300 rounded px-2 py-2" required>
                            <input type="password" id="popover-pass" placeholder="Senha" class="w-full text-xs border border-stone-300 rounded px-2 py-2" required>
                            <button type="submit" class="w-full bg-stone-800 text-white text-xs font-bold py-2 rounded">Entrar</button>
                        </form>
                    </div>
                    <div id="auth-view-user" class="hidden p-5 text-center">
                        <p id="popover-user-email" class="text-xs font-bold text-stone-800 mb-3 truncate">...</p>
                        <button id="btn-logout-popover" class="w-full border border-red-200 bg-red-50 text-red-600 text-xs font-bold py-2 rounded">Sair</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <nav class="lg:hidden flex bg-white border-b border-stone-200 overflow-x-auto shrink-0 z-10">
        <button onclick="ui.switchTab('late')" id="tab-late" class="tab-btn flex-1 py-3 text-sm font-medium text-stone-500 border-b-2 border-transparent">Passados</button>
        <button onclick="ui.switchTab('today')" id="tab-today" class="tab-btn active flex-1 py-3 text-sm font-medium text-stone-500 border-b-2 border-transparent">Hoje</button>
        <button onclick="ui.switchTab('future')" id="tab-future" class="tab-btn flex-1 py-3 text-sm font-medium text-stone-500 border-b-2 border-transparent">Jornada</button>
    </nav>

    <main id="main-kanban" class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-px bg-stone-200 overflow-hidden relative">
        <section id="col-late" class="kanban-column hidden lg:flex flex-col bg-stone-50 h-full min-w-0">
            <div class="px-4 py-3 border-b border-stone-200 bg-stone-100 flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-serif font-bold text-stone-600 flex items-center gap-2 text-sm">
                    <i data-lucide="history" class="w-4 h-4"></i> Pendentes / Passados
                </h2>
                <span id="count-late" class="bg-stone-200 text-stone-600 text-xs px-2 py-0.5 rounded-full font-bold">0</span>
            </div>
            <div id="list-late" class="p-4 overflow-y-auto custom-scroll space-y-3 flex-1"></div>
        </section>

        <section id="col-today" class="kanban-column flex flex-col bg-white h-full min-w-0 shadow-lg z-10">
            <div class="px-4 py-3 border-b border-stone-100 bg-white flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-serif font-bold text-amber-700 flex items-center gap-2 text-sm">
                    <i data-lucide="sun" class="w-4 h-4"></i> Para Refletir Hoje
                </h2>
                <span id="count-today" class="bg-amber-100 text-amber-800 text-xs px-2 py-0.5 rounded-full font-bold">0</span>
            </div>
            <div id="list-today" class="p-4 overflow-y-auto custom-scroll space-y-3 flex-1"></div>
        </section>

        <section id="col-future" class="kanban-column hidden lg:flex flex-col bg-stone-50 h-full min-w-0">
            <div class="px-4 py-3 border-b border-stone-200 bg-stone-100 flex flex-col gap-2 sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <h2 class="font-serif font-bold text-stone-500 flex items-center gap-2 text-sm">
                        <i data-lucide="calendar" class="w-4 h-4"></i> Jornada Futura
                    </h2>
                    <span id="count-future" class="bg-white text-stone-500 text-[10px] px-2 py-0.5 rounded-full font-bold border border-stone-200">0</span>
                </div>
            </div>
            <div id="list-future" class="p-3 overflow-y-auto custom-scroll space-y-3 flex-1"></div>
        </section>   
    </main>

    <div id="modal-new" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 overflow-hidden transform transition-all flex flex-col">
            <div class="bg-stone-50 px-6 py-4 border-b border-stone-100 flex justify-between items-center">
                <h3 class="text-lg font-serif font-bold text-stone-800">Nova Reflexão</h3>
                <button onclick="ui.toggleModal('modal-new', false)" class="text-stone-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="form-study" class="p-6 space-y-5">
                <div>
                    <label class="block text-xs font-semibold text-stone-500 uppercase mb-1.5 tracking-wide">Data da Ministração</label>
                    <input type="date" id="input-study-date" required class="w-full border border-stone-300 rounded-lg p-3 text-stone-700 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-stone-500 uppercase mb-1.5 tracking-wide">Tema / Passagem</label>
                    <input type="text" id="input-topic" required placeholder="Ex: Salmos 23 - O Senhor é meu Pastor" class="w-full border border-stone-300 rounded-lg p-3 text-stone-700 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-stone-500 uppercase mb-1.5 tracking-wide">Link de Referência (Youtube/Drive)</label>
                    <input type="url" id="input-study-link" placeholder="https://..." class="w-full border border-stone-300 rounded-lg p-3 text-stone-700 focus:outline-none focus:ring-2 focus:ring-amber-500 text-xs">
                </div>

                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="ui.toggleModal('modal-new', false)" class="flex-1 px-4 py-2.5 border border-stone-300 rounded-lg text-stone-700 font-medium hover:bg-stone-50">Cancelar</button>
                    <button type="submit" class="flex-1 px-4 py-2.5 bg-stone-800 text-white rounded-lg hover:bg-stone-700 font-medium shadow-md">Salvar Reflexão</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-heatmap" class="fixed inset-0 bg-stone-900/40 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-stone-50 px-6 py-4 border-b border-stone-100 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-serif font-bold text-stone-800 flex items-center gap-2">
                    <i data-lucide="activity" class="text-amber-600"></i> Radar Espiritual (30 Dias)
                </h3>
                <button onclick="ui.toggleModal('modal-heatmap', false)" class="text-stone-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll bg-stone-50">
                <div id="heatmap-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
            </div>
        </div>
    </div>

    <div id="modal-changelog" class="fixed inset-0 bg-stone-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) ui.toggleChangelog(false)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 p-6 relative">
            <button onclick="ui.toggleChangelog(false)" class="absolute top-4 right-4 text-stone-400 hover:text-stone-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-serif font-bold mb-4 flex items-center gap-2 text-stone-800">
                <i data-lucide="history" class="text-amber-600"></i> Histórico do Selah
            </h2>
            <div id="changelog-content" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scroll"></div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <script src="assets/js/changelog.js"></script>
    <script src="assets/js/core.js"></script>
    <script src="assets/js/engine.js"></script>
    <script src="assets/js/fileManager.js"></script>
    <script src="assets/js/view.js"></script>
    <script src="assets/js/controller.js"></script> 
</body>
</html>
